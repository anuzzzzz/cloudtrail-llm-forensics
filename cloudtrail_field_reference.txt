
================================================================================
CLOUDTRAIL EVENT STRUCTURE - COMPREHENSIVE REFERENCE GUIDE
================================================================================
Author: Research Notes
Date: November 22, 2025
Dataset: flaws.cloud CloudTrail logs (1.9M events, 2017-2020)

================================================================================
1. userAgent
================================================================================
TYPE: String
EXAMPLE: "[S3Console/0.4]", "aws-cli/1.16.102", "Boto3/1.9.92"

DESCRIPTION:
- Identifies the software/tool used to make the AWS API call
- Contains version information
- Can help identify attack techniques (manual vs automated)

COMMON VALUES:
- [S3Console/0.4] = AWS Web Console (browser-based)
- aws-cli/X.X.X = AWS Command Line Interface
- Boto3/X.X.X = Python AWS SDK
- aws-sdk-java/X.X.X = Java AWS SDK
- [APN/1.0 HashiCorp/1.0 Terraform/X.X.X] = Infrastructure-as-code tools

FORENSIC VALUE:
- Tool fingerprinting (what did the attacker use?)
- Distinguish human (console) vs automated (CLI/SDK) attacks
- Track attacker sophistication level
- Version analysis (are they using outdated tools?)

GRAPH ANALYSIS: Not directly used, but useful for attack profiling

================================================================================
2. eventID
================================================================================
TYPE: String (UUID format)
EXAMPLE: "3038ebd2-c98a-4c65-9b6e-e22506292313"

DESCRIPTION:
- Globally unique identifier for this specific CloudTrail event
- Generated by AWS CloudTrail service
- Guaranteed to be unique across all events

USE CASES:
- Deduplication (ensure you don't process same event twice)
- Event tracking across multiple log sources
- Correlation with other AWS services
- Audit trail verification

FORENSIC VALUE:
- Reference specific events in incident reports
- Link events across different analysis tools
- Verify log integrity

GRAPH ANALYSIS: Not used (just metadata)

================================================================================
3. userIdentity (⭐ MOST CRITICAL FIELD)
================================================================================
TYPE: Dictionary/Object
STRUCTURE:
{
  "type": "Root" | "IAMUser" | "AssumedRole" | "FederatedUser" | "AWSAccount",
  "principalId": "<unique-id>",
  "arn": "arn:aws:iam::ACCOUNT_ID:user/USERNAME",
  "accountId": "811596193553",
  "userName": "backup",  // Only for IAMUser type
  "sessionContext": {    // Only for AssumedRole type
    "attributes": {...}
  }
}

DESCRIPTION:
- Identifies WHO performed the action
- Most complex and important field in CloudTrail
- Contains multiple sub-fields depending on identity type

SUB-FIELDS EXPLAINED:

3a. type
--------
VALUES:
- "Root" = AWS account root user (highest privilege, should never be used)
- "IAMUser" = Regular IAM user (human or service account)
- "AssumedRole" = Temporary credentials from role assumption
- "FederatedUser" = External identity (SSO, SAML)
- "AWSAccount" = Another AWS account
- "AWSService" = AWS service acting on your behalf

FORENSIC VALUE:
- Root usage = major security red flag
- AssumedRole = indicates role switching (privilege escalation)
- Track identity types used during attack

3b. principalId
---------------
EXAMPLE: "AIDAI4VF2NFB2E5TDI3GI", "811596193553", "AROAI4E1FBACLY3FPC6BB:Level6"

DESCRIPTION:
- Unique identifier for the identity
- Format varies by identity type:
  * Root: AWS account ID (12 digits)
  * IAMUser: "AIDA" prefix + random string
  * AssumedRole: "AROA" prefix + ":" + session name
  * Service: Service name

FORENSIC VALUE:
- Tracks specific identity across multiple events
- Survives username changes (userName can be changed, principalId cannot)
- Links temporary sessions back to original role

3c. arn (Amazon Resource Name)
------------------------------
EXAMPLE: "arn:aws:iam::811596193553:user/Level6"

FORMAT: arn:partition:service:region:account-id:resource-type/resource-name

DESCRIPTION:
- Globally unique identifier in AWS
- Hierarchical path to the identity
- Most reliable way to identify users

COMPONENTS:
- arn = Always "arn"
- partition = "aws" (or aws-cn, aws-gov for special regions)
- service = "iam" (for IAM identities) or "sts" (for assumed roles)
- region = Usually empty for IAM (IAM is global)
- account-id = 12-digit AWS account number
- resource = user/USERNAME or role/ROLENAME

FORENSIC VALUE:
- Unambiguous identity tracking
- Cross-account analysis (see which accounts are involved)
- Parse to extract username/role name

3d. accountId
-------------
EXAMPLE: "811596193553"

DESCRIPTION:
- The AWS account ID that owns this identity
- 12-digit number
- In flaws.cloud dataset, should be consistent (single account)

FORENSIC VALUE:
- Detect cross-account access
- Verify all actions are within expected account
- Identify compromised accounts in multi-account environments

3e. userName
------------
EXAMPLE: "backup", "Level6", "admin"

DESCRIPTION:
- Human-readable name for IAM users
- Only present for IAM User type (not Root or AssumedRole)
- This is what you typically think of as "the user"

FORENSIC VALUE:
- Primary identifier for tracking attackers in this dataset
- "backup", "Level5", "Level6" = known attack progression users
- Easy to read in reports (vs cryptic ARNs)

GRAPH ANALYSIS:
✅✅✅ CRITICAL - This is your primary NODE identifier
- Use userName as graph node label
- If userName missing, fall back to principalId or parse ARN

3f. sessionContext
------------------
EXAMPLE:
{
  "attributes": {
    "mfaAuthenticated": "false",
    "creationDate": "2017-02-12T19:57:05Z"
  },
  "sessionIssuer": {
    "type": "Role",
    "principalId": "AROAI...",
    "arn": "arn:aws:iam::...:role/RoleName",
    "accountId": "...",
    "userName": "RoleName"
  }
}

DESCRIPTION:
- Present for AssumedRole and Root with MFA
- Contains session metadata

SUB-FIELDS:
- mfaAuthenticated: Was MFA used? (should be "true" for sensitive ops)
- creationDate: When the session started
- sessionIssuer: For assumed roles, shows the ORIGINAL role (before assumption)

FORENSIC VALUE:
- Track MFA bypass (if "false" for sensitive operations)
- Reconstruct role assumption chains (who assumed what)
- Session duration analysis

================================================================================
4. eventType
================================================================================
TYPE: String
EXAMPLE: "AwsApiCall", "AwsServiceEvent", "AwsConsoleSignIn"

DESCRIPTION:
- Categorizes the type of CloudTrail event
- Most events are "AwsApiCall"

VALUES:
- AwsApiCall = Standard API call (99% of events in this dataset)
- AwsServiceEvent = AWS service acting automatically
- AwsConsoleSignIn = User logging into AWS Console
- AwsConsoleAction = Action via AWS Console (newer format)

FORENSIC VALUE:
- Filter to API calls only
- Identify console login events (potential compromise)
- Distinguish user actions vs service actions

GRAPH ANALYSIS: Filter to "AwsApiCall" for API-based graphs

================================================================================
5. sourceIPAddress
================================================================================
TYPE: String
EXAMPLE: "255.253.125.115", "52.46.141.160", "AWS Internal"

DESCRIPTION:
- IP address that originated the request
- In flaws.cloud dataset: ANONYMIZED (randomly changed)
- Real-world: actual attacker IP

VALUES:
- Public IP addresses (e.g., "203.0.113.42")
- "AWS Internal" = Request from AWS service itself
- Private IPs (should not appear in CloudTrail normally)

IMPORTANT FOR FLAWS.CLOUD:
⚠️ IPs are anonymized with random values
- Same attacker may appear with multiple IPs
- Do NOT use for threat intel or blocking
- Real IP has been replaced to protect CTF participants

FORENSIC VALUE (in real scenarios):
- Geolocation of attacker
- Identify suspicious IPs (foreign countries, known bad actors)
- Cluster attacks by source
- Correlate with firewall logs

GRAPH ANALYSIS: 
- Could create IP-based clustering (but not reliable in this dataset)
- Real-world: useful for multi-source attack detection

================================================================================
6. eventName (⭐ CRITICAL FOR GRAPH EDGES)
================================================================================
TYPE: String
EXAMPLE: "ListBuckets", "AssumeRole", "GetObject", "PutUserPolicy"

DESCRIPTION:
- The specific AWS API action that was performed
- Corresponds to AWS API documentation
- Most important field for understanding WHAT happened

CATEGORIES OF EVENTS:

S3 Operations:
- ListBuckets = List all S3 buckets in account
- GetObject = Download a file
- PutObject = Upload a file
- DeleteObject = Delete a file
- GetBucketAcl = Check bucket permissions
- GetBucketLocation = Check bucket region

IAM Operations:
- GetUser = Get user information
- ListUsers = List all users
- AttachUserPolicy = Grant permissions to user
- PutUserPolicy = Add inline policy to user
- CreateAccessKey = Create new API keys
- ListAccessKeys = List user's API keys

STS (Security Token Service):
- AssumeRole = Switch to a different role (⭐ GRAPH EDGE!)
- GetSessionToken = Get temporary credentials
- GetFederationToken = Get federated credentials

EC2 Operations:
- DescribeInstances = List EC2 instances
- RunInstances = Launch new EC2
- StopInstances = Stop EC2
- TerminateInstances = Delete EC2

FORENSIC VALUE:
- Reconstruct attacker's exact actions
- Identify privilege escalation attempts (IAM operations)
- Track lateral movement (AssumeRole)
- Detect data exfiltration (GetObject on sensitive buckets)

GRAPH ANALYSIS:
✅✅✅ CRITICAL
- AssumeRole = Creates directed edge in graph (User A → Role B)
- AttachUserPolicy / PutUserPolicy = Permission edges
- GetSessionToken = Temporary credential edges

KEY EVENTS FOR GRAPH CONSTRUCTION:
1. AssumeRole (PRIMARY EDGE) - role switching
2. GetSessionToken - temp creds
3. GetFederationToken - federated access
4. AttachUserPolicy - permission granting
5. PutUserPolicy - inline policy creation
6. AttachRolePolicy - role permissions
7. PutRolePolicy - inline role policy

================================================================================
7. eventSource
================================================================================
TYPE: String
EXAMPLE: "s3.amazonaws.com", "iam.amazonaws.com", "sts.amazonaws.com"

DESCRIPTION:
- Which AWS service API was called
- Corresponds to AWS service domains

COMMON VALUES:
- s3.amazonaws.com = S3 storage operations
- iam.amazonaws.com = Identity and Access Management
- sts.amazonaws.com = Security Token Service (role assumptions!)
- ec2.amazonaws.com = EC2 compute instances
- lambda.amazonaws.com = Lambda functions
- dynamodb.amazonaws.com = DynamoDB database
- cloudtrail.amazonaws.com = CloudTrail itself

FORENSIC VALUE:
- Service-level filtering (focus on IAM operations)
- Track which services the attacker interacted with
- Identify unusual service usage patterns

GRAPH ANALYSIS:
✅ Useful for filtering
- Focus on "sts.amazonaws.com" for role assumptions
- Focus on "iam.amazonaws.com" for privilege escalation

================================================================================
8. recipientAccountId
================================================================================
TYPE: String
EXAMPLE: "811596193553"

DESCRIPTION:
- The AWS account that received/processed the request
- Usually the same as the account in userIdentity
- Different in cross-account scenarios

USE CASES:
- Multi-account environments (organization with many accounts)
- Cross-account role assumptions
- Resource sharing between accounts

FORENSIC VALUE:
- Detect unexpected cross-account access
- Verify all actions are within authorized accounts
- Track lateral movement across AWS accounts

GRAPH ANALYSIS:
- In single-account datasets (like flaws.cloud): not useful
- In multi-account: could create account-level graph nodes

================================================================================
9. requestParameters (⭐ CRITICAL FOR AssumeRole)
================================================================================
TYPE: Dictionary/Object or null
EXAMPLE:
{
  "roleArn": "arn:aws:iam::811596193553:role/Level6",
  "roleSessionName": "attacker-session"
}

DESCRIPTION:
- The parameters sent with the API call
- Content varies by eventName
- Often null for read-only operations
- CRITICAL for AssumeRole events

EXAMPLES BY EVENT TYPE:

AssumeRole:
{
  "roleArn": "arn:aws:iam::...:role/TargetRole",  ⭐ TARGET NODE
  "roleSessionName": "session-name"
}

AttachUserPolicy:
{
  "userName": "backup",
  "policyArn": "arn:aws:iam::aws:policy/AdministratorAccess"
}

GetObject:
{
  "bucketName": "secret-data",
  "key": "passwords.txt"
}

RunInstances:
{
  "instanceType": "t2.micro",
  "imageId": "ami-12345678"
}

FORENSIC VALUE:
- See exactly what the attacker requested
- Identify targets (which roles, which files, which resources)
- Reconstruct attack parameters

GRAPH ANALYSIS:
✅✅✅ CRITICAL FOR EDGES
- For AssumeRole: requestParameters.roleArn = TARGET NODE
- Creates directed edge: userIdentity → roleArn
- This is how you build the privilege escalation graph!

PARSING EXAMPLE:
Event: AssumeRole
Source: userIdentity.arn = "arn:aws:iam::...:user/backup"
Target: requestParameters.roleArn = "arn:aws:iam::...:role/Level6"
Edge: backup → Level6

================================================================================
10. awsRegion
================================================================================
TYPE: String
EXAMPLE: "us-east-1", "us-west-2", "eu-west-1"

DESCRIPTION:
- AWS region where the API call was processed
- Some services are global (e.g., IAM) and show "us-east-1"

COMMON REGIONS:
- us-east-1 = US East (N. Virginia) - default region
- us-west-2 = US West (Oregon)
- eu-west-1 = Europe (Ireland)
- ap-southeast-1 = Asia Pacific (Singapore)

FORENSIC VALUE:
- Geographic distribution of attacks
- Identify unexpected regions (e.g., attacker in foreign country)
- Track multi-region reconnaissance

GRAPH ANALYSIS: Not directly used, but could add region as node attribute

================================================================================
11. requestID
================================================================================
TYPE: String
EXAMPLE: "83A6C73FE87F51FF"

DESCRIPTION:
- AWS's internal tracking ID for this request
- Unique per request
- Used by AWS Support for debugging

FORENSIC VALUE:
- Correlation with AWS Support tickets
- Link CloudTrail with other AWS logs (VPC Flow, ALB logs)
- Verify request uniqueness

GRAPH ANALYSIS: Not used

================================================================================
12. responseElements
================================================================================
TYPE: Dictionary/Object or null
EXAMPLE: Usually null (for privacy/security)

DESCRIPTION:
- What AWS returned in response to the API call
- Often redacted/null in CloudTrail for security
- May contain created resource IDs

WHEN POPULATED:
- CreateAccessKey: Returns new access key ID (not secret!)
- AssumeRole: Returns temporary credentials (not the actual credentials!)
- CreateBucket: Returns bucket name

FORENSIC VALUE:
- Track created resources (new users, keys, buckets)
- Verify success/failure of operations
- Often limited due to AWS redaction

GRAPH ANALYSIS: Rarely useful (usually null)

================================================================================
13. eventVersion
================================================================================
TYPE: String
EXAMPLE: "1.04", "1.05", "1.08"

DESCRIPTION:
- CloudTrail log format version
- Changes when AWS updates the log schema
- flaws.cloud dataset: mostly "1.04" (2017-2020 era)

FORENSIC VALUE:
- Ensure parser handles correct schema version
- Track when AWS changed log formats

GRAPH ANALYSIS: Not used

================================================================================
14. eventTime (⭐ CRITICAL FOR TEMPORAL ANALYSIS)
================================================================================
TYPE: String (ISO 8601 format)
EXAMPLE: "2017-02-12T19:57:06Z"

FORMAT: YYYY-MM-DDTHH:MM:SSZ
- T = separator between date and time
- Z = UTC timezone

DESCRIPTION:
- Exact timestamp when the event occurred
- Always in UTC (Z = Zulu time = UTC)
- Microsecond precision in some versions

FORENSIC VALUE:
- Reconstruct attack timeline
- Calculate dwell time (time between compromise and detection)
- Identify rapid-fire attacks (many events in short time)
- Correlate with other log sources

GRAPH ANALYSIS:
✅✅✅ CRITICAL FOR TEMPORAL GRAPHS
- Sort events chronologically
- Build time-series graphs
- Track attack progression over time
- Identify privilege escalation sequences

TEMPORAL ANALYSIS EXAMPLES:
1. Privilege Escalation Timeline:
   10:00 - backup user lists users
   10:05 - backup assumes Level6 role
   10:10 - Level6 reads secrets

2. Rapid Reconnaissance:
   14:00:00 - ListBuckets
   14:00:01 - GetBucketAcl (bucket1)
   14:00:02 - GetBucketAcl (bucket2)
   ... (automated scanning)

================================================================================
ADDITIONAL FIELDS (Not in this example, but may appear)
================================================================================

errorCode
---------
EXAMPLE: "AccessDenied", "NoSuchBucket"
APPEARS: Only when API call fails
VALUE: Indicates why the request failed

errorMessage
------------
EXAMPLE: "User: arn:aws:iam::...:user/backup is not authorized to perform..."
APPEARS: Only when API call fails
VALUE: Detailed error description

resources
---------
EXAMPLE: [{"arn": "arn:aws:s3:::my-bucket", "type": "AWS::S3::Bucket"}]
APPEARS: Some events
VALUE: Resources affected by the action

vpcEndpointId
-------------
APPEARS: When accessed via VPC endpoint
VALUE: VPC endpoint identifier

================================================================================
GRAPH CONSTRUCTION CHEAT SHEET
================================================================================

PRIMARY NODE: userIdentity.userName (or principalId if userName missing)
PRIMARY EDGE: AssumeRole events

TO BUILD A GRAPH:

1. Filter to graph-relevant events:
   - AssumeRole (main edge type)
   - GetSessionToken
   - AttachUserPolicy / PutUserPolicy

2. Extract nodes:
   SOURCE = userIdentity.userName (e.g., "backup")
   TARGET = parse from requestParameters.roleArn (e.g., "Level6")

3. Create directed edge:
   backup → Level6

4. Add temporal ordering:
   Sort by eventTime
   Track progression: backup (Feb 12) → Level6 (Feb 26)

5. Add attributes:
   Node: username, accountId, type
   Edge: eventName, timestamp, sourceIP

================================================================================
FLAWS.CLOUD SPECIFIC NOTES
================================================================================

KNOWN ATTACK USERS:
- Level1, Level2, Level3, Level4, Level5, Level6 (CTF levels)
- backup (high-privilege account used in attacks)
- SecurityMonkey (security tool, may be compromised)

ATTACK PROGRESSION (Expected):
UnknownUser → Level5 → Level6 → backup → Admin

ANONYMIZATION NOTES:
- IPs are randomized (not real attacker IPs)
- Account ID changed to 811596193553
- Some identifying info replaced with "REDACTED"

DATASET CHARACTERISTICS:
- 1.9M events
- 2017-2020 timespan
- Mostly noise (scanners, failed attempts)
- Core attack: ~10K-50K events
- 79K AssumeRole events (strong graph signal!)

================================================================================
